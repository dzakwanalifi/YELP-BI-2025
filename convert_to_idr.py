import csv
from datetime import datetime

# Data kurs USD-IDR (dari TradingEconomics)
exchange_rates = {
    "2020-11-30": 14085, "2020-12-07": 14070, "2020-12-14": 14080, "2020-12-21": 14150, "2020-12-28": 14040,
    "2021-01-04": 13980, "2021-01-11": 14010, "2021-01-18": 14020, "2021-01-25": 14020,
    "2021-02-01": 14020, "2021-02-08": 13970, "2021-02-15": 14060, "2021-02-22": 14240,
    "2021-03-01": 14290, "2021-03-08": 14380, "2021-03-15": 14400, "2021-03-22": 14410, "2021-03-29": 14520,
    "2021-04-05": 14560, "2021-04-12": 14560, "2021-04-19": 14520, "2021-04-26": 14440,
    "2021-05-03": 14280, "2021-05-10": 14195, "2021-05-17": 14350, "2021-05-24": 14280, "2021-05-31": 14290,
    "2021-06-07": 14188, "2021-06-14": 14370, "2021-06-21": 14420, "2021-06-28": 14530,
    "2021-07-05": 14525, "2021-07-12": 14495, "2021-07-19": 14490, "2021-07-26": 14460,
    "2021-08-02": 14350, "2021-08-09": 14385, "2021-08-16": 14450, "2021-08-23": 14415, "2021-08-30": 14260,
    "2021-09-06": 14200, "2021-09-13": 14225, "2021-09-20": 14255, "2021-09-27": 14305,
    "2021-10-04": 14220, "2021-10-11": 14070, "2021-10-18": 14120, "2021-10-25": 14165,
    "2021-11-01": 14325, "2021-11-08": 14233, "2021-11-15": 14235, "2021-11-22": 14300, "2021-11-29": 14395,
    "2021-12-06": 14370, "2021-12-13": 14365, "2021-12-20": 14220, "2021-12-27": 14250,
    "2022-01-03": 14355, "2022-01-10": 14295, "2022-01-17": 14335, "2022-01-24": 14385, "2022-01-31": 14378,
    "2022-02-07": 14350, "2022-02-14": 14325, "2022-02-21": 14365, "2022-02-28": 14385,
    "2022-03-07": 14300, "2022-03-14": 14340, "2022-03-21": 14340, "2022-03-28": 14365,
    "2022-04-04": 14360, "2022-04-11": 14343, "2022-04-18": 14356, "2022-04-25": 14495,
    "2022-05-02": 14495, "2022-05-09": 14610, "2022-05-16": 14650, "2022-05-23": 14575, "2022-05-30": 14435,
    "2022-06-06": 14550, "2022-06-13": 14821, "2022-06-20": 14845, "2022-06-27": 14935,
    "2022-07-04": 14975, "2022-07-11": 14990, "2022-07-18": 15015, "2022-07-25": 14830,
    "2022-08-01": 14890, "2022-08-08": 14665, "2022-08-15": 14835, "2022-08-22": 14815, "2022-08-29": 14895,
    "2022-09-05": 14828, "2022-09-12": 14950, "2022-09-19": 15035, "2022-09-26": 15225,
    "2022-10-03": 15250, "2022-10-10": 15425, "2022-10-17": 15630, "2022-10-24": 15548, "2022-10-31": 15735,
    "2022-11-07": 15490, "2022-11-14": 15685, "2022-11-21": 15670, "2022-11-28": 15425,
    "2022-12-05": 15582, "2022-12-12": 15595, "2022-12-19": 15590, "2022-12-26": 15565,
    "2023-01-02": 15630, "2023-01-09": 15140, "2023-01-16": 15070, "2023-01-23": 14980, "2023-01-30": 14890,
    "2023-02-06": 15130, "2023-02-13": 15200, "2023-02-20": 15220, "2023-02-27": 15295,
    "2023-03-06": 15445, "2023-03-13": 15340, "2023-03-20": 15150, "2023-03-27": 14990,
    "2023-04-03": 14910, "2023-04-10": 14695, "2023-04-17": 14840, "2023-04-24": 14665,
    "2023-05-01": 14670, "2023-05-08": 14745, "2023-05-15": 14920, "2023-05-22": 14950, "2023-05-29": 14985,
    "2023-06-05": 14835, "2023-06-12": 14930, "2023-06-19": 14990, "2023-06-26": 14990,
    "2023-07-03": 15130, "2023-07-10": 14955, "2023-07-17": 15020, "2023-07-24": 15090, "2023-07-31": 15165,
    "2023-08-07": 15210, "2023-08-14": 15280, "2023-08-21": 15290, "2023-08-28": 15235,
    "2023-09-04": 15320, "2023-09-11": 15350, "2023-09-18": 15370, "2023-09-25": 15450,
    "2023-10-02": 15605, "2023-10-09": 15680, "2023-10-16": 15870, "2023-10-23": 15935, "2023-10-30": 15725,
    "2023-11-06": 15690, "2023-11-13": 15490, "2023-11-20": 15560, "2023-11-27": 15480,
    "2023-12-04": 15505, "2023-12-11": 15490, "2023-12-18": 15480, "2023-12-25": 15395,
    "2024-01-01": 15510, "2024-01-08": 15545, "2024-01-15": 15610, "2024-01-22": 15815, "2024-01-29": 15655,
    "2024-02-05": 15630, "2024-02-12": 15615, "2024-02-19": 15590, "2024-02-26": 15695,
    "2024-03-04": 15585, "2024-03-11": 15590, "2024-03-18": 15775, "2024-03-25": 15850,
    "2024-04-01": 15840, "2024-04-08": 16110, "2024-04-15": 16215.7, "2024-04-22": 16241.55, "2024-04-29": 15968.5,
    "2024-05-06": 16059, "2024-05-13": 15957.6, "2024-05-20": 16045, "2024-05-27": 16256.6,
    "2024-06-03": 16277.6, "2024-06-10": 16486.4, "2024-06-17": 16474.4, "2024-06-24": 16352.2,
    "2024-07-01": 16253.5, "2024-07-08": 16110.75, "2024-07-15": 16213, "2024-07-22": 16284.4, "2024-07-29": 16157.85,
    "2024-08-05": 15940, "2024-08-12": 15679.5, "2024-08-19": 15400.95, "2024-08-26": 15532.4,
    "2024-09-02": 15360, "2024-09-09": 15395, "2024-09-16": 15160.8, "2024-09-23": 15124.85, "2024-09-30": 15670,
    "2024-10-07": 15569.15, "2024-10-14": 15460, "2024-10-21": 15635, "2024-10-28": 15715,
    "2024-11-04": 15665, "2024-11-11": 15850, "2024-11-18": 15870, "2024-11-25": 15840,
    "2024-12-02": 15865, "2024-12-09": 15990, "2024-12-16": 16190, "2024-12-23": 16230, "2024-12-30": 16176.1,
    "2025-01-06": 16185, "2025-01-13": 16383, "2025-01-20": 16172, "2025-01-27": 16387,
    "2025-02-03": 16328, "2025-02-10": 16180, "2025-02-17": 16302, "2025-02-24": 16531,
    "2025-03-03": 16300, "2025-03-10": 16328, "2025-03-17": 16509, "2025-03-24": 16604, "2025-03-31": 16745,
    "2025-04-07": 16797, "2025-04-14": 16863, "2025-04-21": 16804, "2025-04-28": 16467,
    "2025-05-05": 16550, "2025-05-12": 16494, "2025-05-19": 16246, "2025-05-26": 16369,
    "2025-06-02": 16316, "2025-06-09": 16285, "2025-06-16": 16417, "2025-06-23": 16240, "2025-06-30": 16187,
    "2025-07-07": 16229, "2025-07-14": 16328, "2025-07-21": 16360, "2025-07-28": 16368,
    "2025-08-04": 16256, "2025-08-11": 16203, "2025-08-18": 16234, "2025-08-25": 16416,
    "2025-09-01": 16379, "2025-09-08": 16408, "2025-09-15": 16644, "2025-09-22": 16678, "2025-09-29": 16565,
    "2025-10-06": 16605, "2025-10-13": 16572, "2025-10-20": 16608, "2025-10-27": 16634,
    "2025-11-03": 16686, "2025-11-10": 16712, "2025-11-17": 16672, "2025-11-24": 16654.9
}

def find_nearest_exchange_rate(target_date):
    """Cari kurs terdekat untuk tanggal tertentu"""
    target_dt = datetime.strptime(target_date, "%Y-%m-%d")

    # Convert all exchange rate dates to datetime
    rate_dates = {datetime.strptime(d, "%Y-%m-%d"): r for d, r in exchange_rates.items()}

    # Find the nearest date
    nearest_date = min(rate_dates.keys(), key=lambda d: abs((d - target_dt).days))
    return rate_dates[nearest_date]

# Baca data harga bensin
input_file = 'indonesia_gasoline_prices_5y.csv'
output_file = 'indonesia_gasoline_prices_5y_idr.csv'

with open(input_file, 'r') as infile, open(output_file, 'w', newline='') as outfile:
    reader = csv.DictReader(infile)
    fieldnames = ['Date', 'Price_USD_per_Liter', 'Exchange_Rate_IDR', 'Price_IDR_per_Liter']
    writer = csv.DictWriter(outfile, fieldnames=fieldnames)

    writer.writeheader()

    for row in reader:
        date = row['Date']
        price_usd = float(row['Price_USD_per_Liter'])

        # Cari kurs terdekat
        exchange_rate = find_nearest_exchange_rate(date)

        # Hitung harga dalam IDR
        price_idr = price_usd * exchange_rate

        writer.writerow({
            'Date': date,
            'Price_USD_per_Liter': price_usd,
            'Exchange_Rate_IDR': exchange_rate,
            'Price_IDR_per_Liter': round(price_idr, 2)
        })

print(f"Konversi selesai! File disimpan sebagai {output_file}")
